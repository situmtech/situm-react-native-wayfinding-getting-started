parameters:
  - name: system
    type: string
  - name: XAPIEMAIL
    type: string
  - name: XAPIKEY
    type: string
  - name: BUILDINGID
    type: string

steps:
 - checkout: self
   fetchDepth: 1
   fetchTags: false
   displayName: Clone repository

 - task: NodeTool@0
   inputs:
     versionSource: 'spec' # 'spec' | 'fromFile'. Required. Source of version. Default: spec.
     versionSpec: $(nodeVersion)

 - bash: |

     echo -e "\n[+] Installing NPM version $(npmVersion)\n"
     npm install -g $(npmVersion)


     echo -e "\n[+] Install plugin dependencies\n"
     npm install

   displayName: Install plugin dependencies

 - bash: |

     export PATH="/usr/local/opt/gnu-sed/libexec/gnubin:$PATH"
     pluginVersion=$(grep version package.json | awk -F"\"" '{print $4}')
     echo "##vso[task.setvariable variable=pluginVersion]$(echo $pluginVersion)"

     echo -e "\n[+] Variables to set:"
     echo -e "\t[+] X-API-EMAIL: ${{ parameters.XAPIEMAIL }}"
     echo -e "\t[+] BUILDINGID: ${{ parameters.BUILDINGID }}"
     echo -e "\t[+] Plugin Version used: $pluginVersion"

     echo "export const SITUM_USER = '${{ parameters.XAPIEMAIL }}';" > src/app/config.js
     echo "export const SITUM_API_KEY = '${{ parameters.XAPIKEY }}';" >> src/app/config.js
     echo "export const BUILDING_ID = '${{ parameters.BUILDINGID }}';" >> src/app/config.js
     echo "export const GOOGLE_API_KEY = '$(MAPS_APIKEY_EXAMPLE)';" >> src/app/config.js
     
     sed -i "s/GOOGLE_API_KEY_HERE/$(MAPS_APIKEY_EXAMPLE)/" android/app/src/main/AndroidManifest.xml

   displayName: Configure credentials
 

